\begin{DoubleSpace*}
\section{The challenge of identifying compounds from mass spectrometry data}
The identification of compounds from chromatography-coupled mass spectrometry experiments remains a great challenge of untargeted metabolomics \cite{domingo2017,uppal2017,uppal2016,dunn2012}. Many pieces of information may be available to assist in determining the chemical identity of features detected in such experiments including \cite{dunn2012}: the mass-to-charge ratio (m/z) of the ions that have been observed, the fragmentation pattern of either parent or fragment ions, isotopic distribution (e.g. the relative abundance of isotopes can be evaluated by comparing the ratio of 13C to 12C), the observed elution times from separation such as liquid or gas chromatography, and peak shape. Which of these classes of information should be used to identify compounds is largely analytical platform dependent. A further complication of assigning compound identity to the features observed in an experiment is that each compound that elutes from a column and is ionized (such as by electrospray ionization) generates multiple types of ions and adduct ions. In GC-MS analyses the derivatization process is not a uniform process \cite{halket2003}. When electrospray ionization (ESI) is utilized to ionize injected molecules, multiple types of adducted ions may be formed (e.g. sodium adducts) in pronated, non-pronated, or de-pronated form dependent on ESI mode \cite{dunn2012}. Additionally, other isotopologue ions may be present \cite{kuhl2011}. 

A system for representing the level of confidence in a compound annotation has been proposed previously as part of the Metabolomics Standards Initiative (MSI) \cite{sumner2007}. The first level (Level 1) represents the most confident type of identification and requires matching two ``orthogonal'' properties of an observed feature with the properties observed from the analysis of an authentic standard under identical analytical conditions. An example of two orthogonal properties for an LC-MS analysis would be observed m/z and retention time or retention index. In an LC-MS/MS experiment observed m/z and MS/MS fragmentation pattern compared to an authentic standard analyzed under identical analytical condition would constitute a Level 1 identification.  A Level 2 identification also requires matching on ``orthogonal'' properties, but in comparison to previously archived data (e.g. databases such as the NIST libraries) as opposed to authentic standards analyzed under identical conditions). A Level 3 identification is more general and requires association of the properties of an observed feature to those of classes of biochemicals as opposed to specific compounds. This framework asserts in a general way that metabolite annotation is a probabilistic process, in which the likelihood of a match from mass feature to compound label depends on both \emph{a priori} knowledge and empirical data. Consequently, a Bayesian approach to compound identification is sensible. In this chapter we describe previous Bayesian approaches for compound identification utilizing LC-MS data. We do not detail Bayesian approaches for compound ID for MS(n) data, as we are unaware of such efforts to date. Given LC-MS data we describe the assignment of compound labels to m/z features as peak annotation. 

\section{Utilizing feasible metabolic reactions to generate conditional distributions}
Rogers, et al. \cite{rogers2009} introduce the use of prior information for peak annotation in terms of conditional probabilities (although they do not explicitly label it as such). They note that an intense monoisotopic peak for a specific compound should be accompanied by isotopic peaks at specific m/z shifts and with specific intensity ratios. For example the natural abundance ratios of \textsuperscript{12}C and \textsuperscript{13}C may be known in advance. Consequently, the annotation of a compound label to a m/z peak is more likely if the isotopic peaks are also present and at predictable abundance ratios, than a compound label assignment to a m/z peak that would be ``missing'' relevant isotopic peaks. In addition, Rogers et al. invoke previous work \cite{breitling2006} that argues that there is only a small set of possible chemical reactions with a specific compound as an intermediate; consequently the presence of a specific intermediate in a sample should alter the prior (conditional) belief of the likelihood of a limited number of products that could be generated with that intermediate as a substrate being present in the sample.

Rogers et al. introduce an mass measurement likelihood using the following formulation:
\begin{align}
	p(x_m|z_{cm}=1,y_c,\gamma)=N\left(\frac{x_m}{y_c}|1,\gamma^{-1} \right).
\end{align}
In this model, the authors use $x_m$ to represent the observed mass of the $m^{th}$ m/z peak, $z_{cm}$ is a random variable for the assignment of the $c^{th}$ molecular formula to the $m^{th}$ peak, $y_c$ to represent a theoretical mass of the $c^{th}$ molecular formula, and $\gamma$ for the precision of the mass spectrometer. We streamline the notation by introducing the following notation:
\begin{align*}
m_i &:=\text{a mass feature (peak) indexed by integer}\; i, \; i \in \{1,2,\hdots,n \} \\
x_{m_i} &:= \text{measured m/z for mass feature}\; m_i \\
t_{m_i} &:= \text{retention time for mass feature}\; m_i \\
\ell_j &:= \text{a possible compound label for a mass feature}\; j\in\{1, 2, \hdots, J\} \\
x_{\ell_j} &:= \text{monoisotopic mass of a compound with label}\; \ell_j \\
A_k &:= \text{a possible adduct } \; k\in\{1, 2, \hdots, K\} \\
\mathbfcal{I} &:= \text{Indicator matrix with mass features as rows and labels as columns}
\end{align*} 
The mass error model described by Rogers et al. is then:
\begin{align}
	\left. \frac{x_{m_i}}{x_{\ell_j}} \right| \{ I(m_i=\ell_j )=1 \} \sim N\left(1, \gamma^{-1}\right).
\end{align}
Rogers et al. argue that the conditional probabilities of formula assignments should be predicated on current assignments, and how pairs of molecules can be related by chemical reactions. They present the following form for the conditional probability (rewritten using our notation):
\begin{align}
p( I(m_i=\ell_j )=1|\mathbfcal{I},\delta) =  \frac{\beta_{ji}+\delta}{N\delta+\sum_{j'i} \beta_{j'i}}
\end{align}
where:
\begin{align}
	\beta_{ji}=\textbf{W}_{j \cdot} \mathbfcal{I} \textbf{1} - \textbf{W}_{j \cdot} \mathbfcal{I}_{\cdot i}, 
\end{align}
with $\textbf{W}$ as an indicator matrix that represents possible biochemical reactions, with $\dim(\textbf{W})=N\times N$, and $\delta$ is a hyperparameter. Given this formulation $\beta_{ji}$ represents a count of the number of biochemical transformations from compound labels currently assigned to result in a new annotation. Rogers et al. then state the discrete conditional distribution of possible compound labels for a mass feature as:
\begin{align}
	p\left(\frac{x_{m_i}}{x_{\ell_j}}\right) \propto N(1, \gamma^{-1})  \frac{\beta_{ji}+\delta}{N\delta+\sum_{j'i} \beta_{j'i}}.
\end{align}
Rogers et al. in their supplemental material specify a Dirichlet-categorical prior for each set of compounds that could be generated by chemical reactions:
\begin{align}
	p(\boldsymbol{\beta}|\boldsymbol{\delta})=\frac{\Gamma(\sum_j \delta_j) \prod_j \Gamma(\beta_{ji}+\delta_j)}{\Gamma(\sum_j \beta_{ji}+\delta_j) \prod_j \Gamma(\delta_j)}.
\end{align}
Although not explicitly stated, the posterior probability distribution of assignment in the form $\text{Posterior} \propto \text{Likelihood} \times \text{Prior}$ described in Rogers et al. is:
\begin{align}
	\propto p\left(\frac{x_{m_i}}{x_{\ell_j}}\right) p(\boldsymbol{\beta}|\boldsymbol{\delta})
\end{align}
From this a Gibbs sampler was formulated for simulating the posterior distribution of compound labels for each mass feature. 

\section{Utilizing isotope patterns in conditional distributions}
Rogers et al. \cite{rogers2009} additionally discuss a method for incorporating prior information regarding monoisotopic-isotopic peak presence and intensity information. The additional likelihood term described is presented here (in our notation), although this formulation does not provide sufficient detail for understanding the process of incorporating this likelihood term:
\begin{align*}
p( I(m_i=\ell_j )=1|\omega_{ji},\delta) = \frac{\omega_{j'i}+\delta}{N \delta + \sum_{j'}\omega_{j'i}}.
\end{align*}
In this equation, $\omega_{j'i}$ is said to represent the number of possible mass features (already assigned a compound label) that generate an isotopic peak $m_i$, or possible isotopic peaks that could be associated with a monoisotopic peak. Roger's et al. describe using heuristic rules such as a relative tolerance for matching a hypothetical isotope-to-monoisotope intensity ratio versus theoretical expectation.

\section{``ProbMetab'': Formalization and integration of pathway databases}
Blah 
\begin{align}
	p(x_m|\mathbfcal{I},x^{(-m)},\boldsymbol{\theta}) \propto p_N(x_m|\mathbfcal{I},\theta_N) \cdot p_{rt}(x_m|\mathbfcal{I},\theta_{rt}) p_{iso}(x_m|Z,\theta_{iso})
\end{align}

\end{DoubleSpace*}